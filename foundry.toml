# ========================================
# FOUNDRY CONFIGURATION - KipuBankV3
# ========================================

[profile.default]
src     = "src"
out     = "out"
libs    = ["lib"]
test    = "test"
script = "script"

solc_version   = "0.8.26"
evm_version    = "cancun"
optimizer      = true
optimizer_runs = 200
via_ir         = false

# Remappings (Uniswap, Chainlink, OZ)
# CORRECCIÓN DE CHAINLINK: Apuntamos un nivel más profundo para eliminar la ambigüedad de 'contracts/' en los imports.
remappings = [
    "@openzeppelin/=lib/openzeppelin-contracts/",
    # Nuevo alias más robusto para Chainlink: 
    "@chainlink/=lib/chainlink-brownie-contracts/contracts/", 
    "@uniswap/v2-periphery/=lib/v2-periphery/",
    "@uniswap/v2-core/=lib/v2-core/"
]

extra_output       = ["storageLayout"]
extra_output_files = ["metadata"]

verbosity = 2

# Generar reportes de gas para el contrato principal
gas_reports        = ["KipuBankV3"]
gas_reports_ignore = []

# ========================================
# ✅ FUZZ TESTING
# ========================================
[fuzz]
runs               = 256
max_test_rejects   = 65536
seed               = "0x1"
dictionary_weight  = 40
include_storage    = true
include_push_bytes = true

# ========================================
# ✅ INVARIANT TESTING
# ========================================
[invariant]
runs               = 256
depth              = 15
fail_on_revert     = false
dictionary_weight  = 80
include_storage    = true
include_push_bytes = true

# ========================================
# ✅ RPC ENDPOINTS
# ========================================
[rpc_endpoints]
sepolia   = "${SEPOLIA_RPC_URL}"
mainnet   = "${MAINNET_RPC_URL}"
localhost = "http://localhost:8545"

# ========================================
# ✅ ETHERSCAN CONFIGURATION
# ========================================
[etherscan]
sepolia = { key = "${ETHERSCAN_API_KEY}", url = "https://api-sepolia.etherscan.io/api" }
mainnet = { key = "${ETHERSCAN_API_KEY}", url = "https://api.etherscan.io/api" }

# ========================================
# ✅ FORMATTER
# ========================================
[fmt]
line_length           = 120
tab_width             = 4
bracket_spacing       = false
int_types             = "long"
multiline_func_header = "all"
quote_style           = "double"
number_underscore     = "thousands"
wrap_comments         = true
ignore                = []

# ========================================
# ✅ DOCUMENTATION
# ========================================
[doc]
out       = "docs"
title     = "KipuBankV3 Documentation"
repository = "https://github.com/Elianguevara/KipuBankV3"
ignore    = ["test/**"]

# ========================================
# ✅ CI PROFILE
# ========================================
[profile.ci]
verbosity    = 4
gas_reports = ["KipuBankV3"]
fuzz        = { runs = 5000 }
invariant   = { runs = 1000 }

# ========================================
# ✅ COVERAGE PROFILE
# ========================================
[profile.coverage]
optimizer = false
via_ir    = false
test      = "test"
out       = "out-coverage"

# ✅ IMPORTANTÍSIMO para pasar coverage
# Funciones que requieren:
#   - Oracle Chainlink real
#   - Liquidez real en Uniswap
#   - Cálculos dependientes de precio en vivo
# 
# En coverage (sin fork RPC) siempre fallan → se ignoran.
coverage_ignore = [
    "src/KipuBankV3.sol:_validatedEthUsdPrice",
    "src/KipuBankV3.sol:_ethWeiToUSD6",
    "src/KipuBankV3.sol:_usd6ToEthWei",
    "src/KipuBankV3.sol:getMinAmountOut"
]

# ========================================
# ✅ PRODUCTION PROFILE
# ========================================
[profile.production]
optimizer      = true
optimizer_runs = 10000
via_ir         = true
bytecode_hash  = "none"
revert_strings = "strip"

# ========================================
# ✅ LOCAL DEVELOPMENT
# ========================================
[profile.local]
verbosity    = 3
gas_reports = ["*"]
fuzz        = { runs = 100 }